#!/usr/bin/env perl

package main;

#  PODNAME: ppp
# ABSTRACT: Preprocess Pandoc before Processing Pandoc

use v5.14;
use strict;
use warnings;
use File::Temp 'tempdir';

# use Smart::Comments;

state $fileno = 0;
state $outfile;
state $format;
state @children;
state %attributes;
state $tmpdir = tempdir( CLEANUP => 0 );

MAIN: {
  while(<>) {
    if ( (my $start = /^~{3,}\s*\{.*?(?<format>rdfdot|ditaa|dot|neato|yuml|plantuml)(?<attributes>.*)\}.*/) ... (my $end = /^~{3,}\s*$/) ) {
        $start ? begin_ppp() : $end ? end_ppp() : print {$outfile} $_
    } else {
      print
    }
  }
}

SUBS: {
  sub begin_ppp {
    $fileno++;
    $format = $+{format};
    $attributes{$fileno.$format} = $+{attributes};
    open $outfile, '>', "$tmpdir/image-$fileno.$format"
  }

  sub end_ppp {
    close $outfile;

    my %attrs = map { /(.+?)=(["']?.+["']?)/ ? ($1 => $2) : ($_ => 1) } split /\s+\./, $attributes{$fileno.$format};
    if( my $child = fork == 0 ) {
       push @children, $child;
       $format =~ /^ditaa$/ and do {
         my $cmd =
          "ditaa " .
          (exists $attrs{"rounded-corners"} ? '--round-corners ' : ' ') .
          (exists $attrs{"no-shadows"}      ? '--no-shadows '    : ' ') .
          (exists $attrs{"no-separation"}   ? '--no-separation ' : ' ') .
          (exists $attrs{"no-antialias"}    ? '--no-antialias '  : ' ') .
          " $tmpdir/image-$fileno.$format $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/ditaa.log"
        ;
        ### $cmd
        system($cmd);
        system("mogrify -scale $attrs{scale} $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/mogrify.log") if exists $attrs{scale};
       };
       $format =~ /^rdfdot$/ and do {
         system("rdfdot -ttl $tmpdir/image-$fileno.$format $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/rdfdot.log");
         system("mogrify -scale $attrs{scale} $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/mogrify.log") if exists $attrs{scale};
       };
       $format =~ /^dot$/ and do {
         system("dot -Tpng -o $tmpdir/image-$fileno.png $tmpdir/image-$fileno.$format 2>&1 >>$tmpdir/dot.log");
         system("mogrify -scale $attrs{scale} $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/mogrify.log") if exists $attrs{scale};
       };
       $format =~ /^neato$/ and do {
         system("neato -Tpng -o $tmpdir/image-$fileno.png $tmpdir/image-$fileno.$format 2>&1 >>$tmpdir/neato.log");
         system("mogrify -scale $attrs{scale} $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/mogrify.log") if exists $attrs{scale};
       };
       $format =~ /^yuml$/ and do {
         my $cmd =
           "yuml " .
           (exists $attrs{"type"}       ? "--type  @{[$attrs{type}      ]} ": '--type=class ') .
           (exists $attrs{"style"}      ? "--style @{[$attrs{style}     ]} ": '--style=boring ') .
           (exists $attrs{"direction"}  ? "--dir   @{[$attrs{direction} ]} ": '--dir=LR ') .
           " --in $tmpdir/image-$fileno.$format --out $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/yuml.log"
         ;
         system($cmd);
         system("mogrify -scale $attrs{scale} $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/mogrify.log") if exists $attrs{scale};
       };
       $format =~ /^plantuml$/ and do {
         system("plantuml -tpng -charset UTF-8 $tmpdir/image-$fileno.$format 2>&1 >>$tmpdir/plantuml.log");
         system("mogrify -scale $attrs{scale} $tmpdir/image-$fileno.png 2>&1 >>$tmpdir/mogrify.log") if exists $attrs{scale};
       };
       exit 0;
    }

    $format =
      "![" . (exists $attrs{title} ? $attrs{title} : '' )
           . (exists $attrs{label} ? "\\label{$attrs{label}}" : '' ).
      "]"  .
      "($tmpdir/image-$fileno.png)" .
      (exists $attrs{inline} ? '\\ ' : '')
    ;
    say STDOUT $format;
    $format = '';
  }
}

END {
  while (1) {
    my $child = waitpid(-1, 0);
    last if $child == -1;       # No more outstanding children
  }
}
